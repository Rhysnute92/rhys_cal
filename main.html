<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie & Macro Tracker</title>
    <link rel="stylesheet" href="rhys_cal.css">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<div class="container">
    <div class="top-actions">
        <button onclick="document.getElementById('add-food-section').scrollIntoView()">+ Add Food</button>
        <button onclick="startScanner()" class="scan-btn">Scan Barcode</button>
    </div>

    <h2>Calorie & Macro Tracker</h2>

    <div id="scanner-container" style="display: none; background: #000; padding: 10px; border-radius: 8px">
        <div id="interactive" style="width: 100%"></div>
        <button onclick="stopScaner()" class="stop-scanner">Close Camera</button>
    </div>

    <div class="calendar" id="calendar"></div>
    <input type="date" id="date" style="display:none;">

    <div style="margin-top:10px;">
        <label>Protein Progress (Goal: 200g)</label>
        <div style="width: auto; background: #eee; border-radius: 10px; height: 20px;">
            <div id="protein-bar" style="width: 0; background: #4CAF50; height: 100%; border-radius: 10px; transition: width 0.5s;"></div>
        </div>
    </div>

    <div style="margin-top:10px;">
        <label>Fat Progress (Goal: 45g)</label>
        <div id="fatprog" style="width: auto; background: #eee; border-radius: 10px; height: 20px;">
            <div id="fat-bar" style="width: 0; background: #4CAF50; height: 100%; border-radius: 10px; transition: width 0.5s;"></div>
        </div>
    </div>

    <div style="margin-top: 10px;">
        <label>Carb Progress (Goal: 145g)</label>
        <div style="width: auto; background: #eee; border-radius: 10px; height: 20px;">
            <div id="carb-bar" style="width: 0; background: #4CAF50; height: 100%; border-radius: 10px; transition: width0.5s;"></div>
        </div>
    </div>

    <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin-top: 10px">
        <label>Base Calories: <input type="number" id="baseCalories" value="1800"></label>
        <label>Training Day?
            <select id="isTraining">
                <option value="no">No</option>
                <option value="yes" selected="selected">Yes</option>
            </select>
        </label>
        <button onclick="setDailyGoal()">Update Goals</button>
        <div id="dailyGoal"></div>
        <div id="remainingCalories" style="font-size: 1.2em; color: green;"></div>
        <div id="protein-remaining" style="font-weight: bold; color: blue;"></div>
        <div id="fat-remaining" style="font-weight: bold; color: red;"></div>
        <div id="carbs-remaining" style="font-weight: bold; color: orange;"></div>
    </div>

    <hr>
    <h3>Add Food</h3>
    <select id="mealCategory">
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Dinner">Dinner</option>
        <option value="Drinks">Drinks</option>
        <option value="Snack">Snack</option>
    </select>
    <input type="text" id="foodName" placeholder="Search food..." oninput="searchFood()">
    <div id="suggestions"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
        <input type="number" id="foodCalories" placeholder="Calories">
        <input type="number" id="protein" placeholder="Protein (g)">
        <input type="number" id="fat" placeholder="Fat (g)">
        <input type="number" id="carbs" placeholder="Carbs (g)">
    </div>
    <button onclick="addFood()" style="margin-top:10px;">Add to Log</button>
    <button onclick="addToDatabase()">Save to Database</button>

    <hr>
    <div id="mealLists">
        <h4>Breakfast</h4><ul id="BreakfastList"></ul>
        <h4>Lunch</h4><ul id="LunchList"></ul>
        <h4>Dinner</h4><ul id="DinnerList"></ul>
        <h4>Drinks</h4><ul id="TeaList"></ul>
        <h4>Snacks</h4><ul id="SnackList"></ul>
    </div>

    <hr>
    <h3>Daily Totals</h3>
    <div id="dailyTotals"></div>
    <canvas id="macroChart"></canvas>
    <canvas id="mealChart"></canvas>

    <hr>
    <h3>Weekly Summary</h3>
    <button onclick="updateWeeklyChart()">Refresh Weekly View</button>
    <div id="weeklySummary"></div>
    <canvas id="weeklyChart"></canvas>

    <div style="margin-top: 20px; display:flex; gap:10px;">
        <button onclick="exportToPDF()">Export PDF</button>
        <button onclick="exportToCSV()">Export CSV</button>
    </div>
</div>

<script>
    // --- STATE ---
    let foodDatabase = JSON.parse(localStorage.getItem('foodDatabase')) || [
        { name: "Chicken Breast", calories: 165, protein: 31, fat: 3.6, carbs: 0 },
        { name: "Rice (100g)", calories: 130, protein: 2.7, fat: 0.3, carbs: 28 },
        { name: "Egg", calories: 70, protein: 6, fat: 5, carbs: 0.6 }
    ];

    let mealFoods = { Breakfast: [], Lunch: [], Dinner: [], Drink: [], Snack: [] };
    let dailyGoalCals = 1800;
    let proteinGoal = 200;
    let fatGoal = 45;
    let carbGoal = 145;
    let macroChart, mealChart, weeklyChart;

    const dateInput = document.getElementById('date');

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];
        buildCalendar(today);
        loadData();
    });

    function buildCalendar(currentDate) {
        const calendarDiv = document.getElementById('calendar');
        calendarDiv.innerHTML = '';
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

        for (let i = 0; i < 7; i++) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + i);
            const btn = document.createElement('button');
            btn.textContent = day.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
            btn.onclick = () => {
                dateInput.value = day.toISOString().split('T')[0];
                document.querySelectorAll('.calendar button').forEach(b => b.classList.remove('active-day'));
                btn.classList.add('active-day');
                loadData();
            };
            if (day.toDateString() === currentDate.toDateString()) btn.classList.add('active-day');
            calendarDiv.appendChild(btn);
        }
    }

    // --- CORE LOGIC ---
    function setDailyGoal() {
        const base = parseInt(document.getElementById('baseCalories').value) || 0;
        const isTraining = document.getElementById('isTraining').value;
        dailyGoalCals = base + (isTraining === 'yes' ? extra : 0);
        saveData();
        updateDailyTotals();
    }

    function searchFood() {
        const query = document.getElementById('foodName').value.toLowerCase();
        const suggestionsDiv = document.getElementById('suggestions');
        suggestionsDiv.innerHTML = '';
        if (query.length === 0) return;
        foodDatabase.filter(f => f.name.toLowerCase().includes(query)).forEach(food => {
            const div = document.createElement('div');
            div.textContent = food.name;
            div.onclick = () => {
                document.getElementById('foodName').value = food.name;
                document.getElementById('foodCalories').value = food.calories;
                document.getElementById('protein').value = food.protein;
                document.getElementById('fat').value = food.fat;
                document.getElementById('carbs').value = food.carbs;
                suggestionsDiv.innerHTML = '';
            };
            suggestionsDiv.appendChild(div);
        });
    }

    function addFood() {
        const category = document.getElementById('mealCategory').value;
        const food = {
            name: document.getElementById('foodName').value,
            calories: parseInt(document.getElementById('foodCalories').value) || 0,
            protein: parseInt(document.getElementById('protein').value) || 0,
            fat: parseInt(document.getElementById('fat').value) || 0,
            carbs: parseInt(document.getElementById('carbs').value) || 0
        };
        if (!food.name || food.calories <= 0) return alert('Invalid entry');

        mealFoods[category].push(food);
        updateMealDisplay(category);
        saveData();
    }

    function updateMealDisplay(category) {
        const list = document.getElementById(category + 'List');
        list.innerHTML = '';

        let sectionTotal = { cal: 0, p: 0, f: 0, c: 0 };

        mealFoods[category].forEach((food, index) => {
            sectionTotal.cal += (food.calories || 0);
            sectionTotal.p += (food.protein || 0);
            sectionTotal.f += (food.fat || 0);
            sectionTotal.c += (food.carbs || 0);

            const li = document.createElement('li');
            li.innerHTML = `
            <span>${food.name}</span>
            <span>${food.calories} kcal <button onclick="removeFood('${category}', ${index})">x</button></span>
        `;
            list.appendChild(li);
        });

        // Target the header <h4>
        const header = document.querySelector(`#${category}List`).previousElementSibling;

        // Create or update the summary div
        let summaryDiv = document.getElementById(category + '-summary');
        if (!summaryDiv) {
            summaryDiv = document.createElement('div');
            summaryDiv.id = category + '-summary';
            summaryDiv.className = 'section-summary';
            header.after(summaryDiv); // Inserts it right between H4 and UL
        }

        summaryDiv.innerHTML = `
        <span><strong>${sectionTotal.cal}</strong> kcal</span>
        <span>P: <strong>${sectionTotal.p}g</strong></span>
        <span>F: <strong>${sectionTotal.f}g</strong></span>
        <span>C: <strong>${sectionTotal.c}g</strong></span>
    `;

        updateDailyTotals();
    }
    function removeFood(category, index) {
        // 1. Remove the item from the array
        mealFoods[category].splice(index, 1);

        // 2. Refresh the visual list for that category
        updateMealDisplay(category);

        // 3. Re-run totals (this 'adds back' the calories to your remaining balance)
        updateDailyTotals();

        // 4. Save the new state
        saveData();
    }

    function updateDailyTotals() {
        let total = { cal: 0, p: 0, f: 0, c: 0 };

        // 1. Calculate totals from all meals
        Object.values(mealFoods).flat().forEach(f => {
            total.cal += (f.calories || 0);
            total.p += (f.protein || 0);
            total.f += (f.fat || 0);
            total.c += (f.carbs || 0);
        });

        // 2. Update Text UI
        document.getElementById('dailyGoal').innerText = `Daily Goal: ${dailyGoalCals} kcal`;
        document.getElementById('remainingCalories').innerText = `Remaining: ${dailyGoalCals - total.cal} kcal`;
        document.getElementById('dailyTotals').innerText = `Total -> Cals: ${total.cal} | P: ${total.p}g | F: ${total.f}g | C: ${total.c}g`;

        document.getElementById('protein-remaining').innerText = `Protein Remaining: ${Math.max(0, proteinGoal - total.p)}g`;
        document.getElementById('fat-remaining').innerText = `Fat Remaining: ${Math.max(0, fatGoal - total.f)}g`;
        document.getElementById('carbs-remaining').innerText = `Carbs Remaining: ${Math.max(0, carbGoal - total.c)}g`;

        // 3. Update Progress Bars (Fixed to use correct macro variables)
        const pPct = Math.min((total.p / proteinGoal) * 100, 100);
        document.getElementById('protein-bar').style.width = pPct + "%";

        const fPct = Math.min((total.f / fatGoal) * 100, 100);
        document.getElementById('fat-bar').style.width = fPct + "%";

        const cPct = Math.min((total.c / carbGoal) * 100, 100);
        document.getElementById('carb-bar').style.width = cPct + "%";

        // 4. Refresh Chart
        drawCharts(total.p, total.f, total.c);
    }
    // --- STORAGE ---
    function saveData() {
        const dateKey = dateInput.value;
        const data = { mealFoods, dailyGoalCals };
        localStorage.setItem('day_' + dateKey, JSON.stringify(data));
    }

    function loadData() {
        const dateKey = dateInput.value;
        const saved = JSON.parse(localStorage.getItem('day_' + dateKey));
        if (saved) {
            mealFoods = saved.mealFoods || { Breakfast: [], Lunch: [], Dinner: [], Tea: [], Snack: [] };
            dailyGoalCals = saved.dailyGoalCals || 1800;
        } else {
            mealFoods = { Breakfast: [], Lunch: [], Dinner: [], Tea: [], Snack: [] };
        }
        Object.keys(mealFoods).forEach(updateMealDisplay);
    }

    // --- CHARTS ---
    function drawCharts(p, f, c) {
        const ctxMacro = document.getElementById('macroChart').getContext('2d');
        if (macroChart) macroChart.destroy();
        macroChart = new Chart(ctxMacro, {
            type: 'doughnut',
            data: {
                labels: ['Protein', 'Fat', 'Carbs'],
                datasets: [{ data: [p*4, f*9, c*4], backgroundColor: ['#4CAF50', '#FF9800', '#2196F3'] }]
            }
        });
    }

    function exportToPDF() {
        window.print();
    }

    function exportToCSV() {
        let csv = "Category,Name,Calories,Protein,Fat,Carbs\n";
        for (let cat in mealFoods) {
            mealFoods[cat].forEach(f => {
                csv += `${cat},${f.name},${f.calories},${f.protein},${f.fat},${f.carbs}\n`;
            });
        }
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Log_${dateInput.value}.csv`;
        a.click();
    }
    // --- DYNAMIC GOAL LOGIC ---
    document.getElementById('isTraining').addEventListener('change', function() {
        const baseInput = document.getElementById('baseCalories');
        const isTraining = this.value;

        if (isTraining === 'no') {
            baseInput.value = 1500;
        } else {
            // Optional: Reset to a higher default if "yes" is selected
            baseInput.value = 1800;
        }

        // Automatically recalculate goals when the dropdown changes
        setDailyGoal();
    });

    // 1. Listen for dropdown changes to update the base input automatically
    document.getElementById('isTraining').addEventListener('change', function() {
        const baseInput = document.getElementById('baseCalories');

        // Logic: No = 1500, Yes = 1800
        if (this.value === 'no') {
            baseInput.value = 1500;
        } else {
            baseInput.value = 1800;
        }

        // 2. Immediately update the total goals and save
        setDailyGoal();
    });

    // 3. The master function to calculate and display goals
    function setDailyGoal() {
        const base = parseInt(document.getElementById('baseCalories').value) || 0;
        const extra = parseInt(document.getElementById('trainingCalories').value) || 0;
        const isTraining = document.getElementById('isTraining').value;

        // Calculate total: If 'yes', add extra. If 'no', just base.
        dailyGoalCals = base + (isTraining === 'yes' ? extra : 0);

        // Update the UI Text
        document.getElementById('dailyGoal').innerText = `Daily Goal: ${dailyGoalCals} kcal`;

        // Save to LocalStorage and refresh calculations
        saveData();
        updateDailyTotals();
    }
    function updateDailyTotals() {
        let total = { cal: 0, p: 0, f: 0, c: 0 };
        Object.values(mealFoods).flat().forEach(f => {
            total.cal += f.calories; total.p += f.protein; total.f += f.fat; total.c += f.carbs;
        });

        // Update Text
        document.getElementById('remainingCalories').innerText = `Remaining: ${dailyGoalCals - total.cal} kcal`;
        document.getElementById('protein-remaining').innerText = `Protein Remaining: ${Math.max(0, proteinGoal - total.p)}g`;
        document.getElementById('fat-remaining').innerText = `Fat Remaining: ${Math.max(0, fatGoal - total.f)}g`
        document.getElementById('carbs-remaining').innerText = `Carbs Remaining: ${Math.max(0, carbGoal - total.c)}g`

        // Update Progress Bar
        const proteinPercent = Math.min((total.p / proteinGoal) * 100, 100);
        document.getElementById('protein-bar').style.width = proteinPercent + "%";

        const fatPercentage = Math.min((total.p / fatGoal) * 100, 100);
        document.getElementById('fat-bar').style.width = fatPercentage + "%";

        const carbPercentage = Math.min((total.p / carbGoal) * 100, 100);
        document.getElementById('carb-bar').style.width = carbPercentage + "%";

        drawCharts(total.p, total.f, total.c);
    }
</script>
</body>
</html>